{% extends 'examigo/base.html' %}

{% block title %}Chat with {{ document.title }} - ExAmigo{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">AI Instructor: {{ document.title }}</h4>
                <a href="{% url 'home' %}" class="btn btn-sm btn-light">Back</a>
            </div>
            <div class="card-body">
                <!-- Chat messages container -->
                <div id="chat-messages" class="chat-container mb-3" style="height: 400px; overflow-y: auto;">
                    {% if not messages %}
                        <div class="system-message text-center p-3">
                            <p class="mb-0">Start chatting with the AI instructor about this document!</p>
                            <small class="text-muted">Ask any questions about the content, request explanations, or explore related topics.</small>
                        </div>
                    {% else %}
                        {% for msg in messages %}
                            <div class="message-container {% if msg.is_user %}text-end{% endif %} mb-3">
                                <div class="message-bubble p-3 {% if msg.is_user %}bg-primary text-white{% else %}bg-light{% endif %} rounded">
                                    {{ msg.content|linebreaks }}
                                </div>
                                <small class="text-muted">{{ msg.timestamp|time:"H:i" }}</small>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
                
                <!-- Message input form -->
                <form id="chat-form" class="mt-3" data-chat-id="{{ chat.id }}">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="Ask about this document..." required>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send"></i> Send
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for handling the chat interface -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatContainer = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const chatId = chatForm.getAttribute('data-chat-id');
    
    // Scroll to bottom of chat
    function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // Initial scroll
    scrollToBottom();
    
    // Add message to chat
    function addMessage(content, isUser, timestamp) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message-container ${isUser ? 'text-end' : ''} mb-3`;
        
        messageDiv.innerHTML = `
            <div class="message-bubble p-3 ${isUser ? 'bg-primary text-white' : 'bg-light'} rounded">
                ${content.replace(/\n/g, '<br>')}
            </div>
            <small class="text-muted">${timestamp || 'Just now'}</small>
        `;
        
        chatContainer.appendChild(messageDiv);
        scrollToBottom();
    }
    
    // Handle form submission
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        if (!message) return;
        
        // Add user message to chat
        addMessage(message, true);
        
        // Clear input
        messageInput.value = '';
        
        // Show loading indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'message-container mb-3';
        loadingDiv.innerHTML = `
            <div class="message-bubble p-3 bg-light rounded">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="ms-2">AI is thinking...</span>
            </div>
        `;
        chatContainer.appendChild(loadingDiv);
        scrollToBottom();
        
        // Send message to server
        fetch(`/chat/message/${chatId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: `message=${encodeURIComponent(message)}`
        })
        .then(response => response.json())
        .then(data => {
            // Remove loading indicator
            chatContainer.removeChild(loadingDiv);
            
            if (data.status === 'success') {
                // Add AI response to chat
                addMessage(data.message, false, data.timestamp);
            } else {
                // Show error
                addMessage(`Error: ${data.message}`, false);
            }
        })
        .catch(error => {
            // Remove loading indicator
            chatContainer.removeChild(loadingDiv);
            
            // Show error
            addMessage(`Failed to send message: ${error}`, false);
        });
    });
});
</script>
{% endblock %}